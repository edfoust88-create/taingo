<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Portal with Shared Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* RESTORED: Background image and styling for logo.jpg */
            background-image: url('logo.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .day-cell {
            min-height: 100px; 
        }
        .completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
    </style>
</head>
<body class="flex items-center justify-center p-4 sm:p-8">

    <!-- Notification Element -->
    <div id="notification" class="hidden fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg fade-in z-50"></div>

    <!-- Main Container -->
    <div class="w-full max-w-6xl mx-auto">

        <!-- Login Section (Initial View) -->
        <div id="login-section" class="bg-white/90 backdrop-blur-sm p-8 rounded-xl shadow-2xl max-w-md mx-auto fade-in">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-teal-700">App Portal Login</h1>
                <p class="text-gray-600 mt-2">Sign in to access your team applications.</p>
            </div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="username" name="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" placeholder="user" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" name="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" placeholder="password" required>
                </div>
                <div id="error-message" class="hidden text-red-600 text-sm text-center mb-4 p-3 bg-red-100 rounded-lg">Invalid username or password.</div>
                <button type="submit" class="w-full bg-teal-600 text-white font-semibold py-3 rounded-lg hover:bg-teal-700 transition shadow-lg">Sign In</button>
                <div class="mt-4 text-center"><p class="text-xs text-gray-500">Hint: Use 'user' and 'password'.</p></div>
            </form>
        </div>

        <!-- Apps Dashboard Section -->
        <div id="apps-dashboard" class="hidden fade-in w-full">
            <header class="bg-white/95 backdrop-blur-sm p-6 rounded-xl shadow-xl mb-8 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Welcome to Your Dashboard</h1>
                    <p class="text-gray-600 mt-1">Select an application to launch.</p>
                    <!-- NEW: User ID Display -->
                    <p class="text-xs text-gray-500 mt-2">Authenticated User ID: <span id="user-id-display" class="font-mono text-gray-700 bg-gray-100 px-2 py-0.5 rounded">Loading...</span></p>
                </div>
                <button id="logout-button" class="bg-red-500 text-white font-semibold px-5 py-2 rounded-lg hover:bg-red-600 transition shadow-md">Logout</button>
            </header>
            <div id="app-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                 <!-- Shared Calendar Card -->
                 <div class="bg-white/90 backdrop-blur-sm p-6 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all">
                    <div class="flex items-center mb-4">
                        <div class="bg-teal-100 p-3 rounded-full">
                           <svg class="w-6 h-6 text-teal-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        </div>
                        <h2 class="text-xl font-bold text-gray-800 ml-4">Shared Calendar</h2>
                    </div>
                    <p class="text-gray-700 mb-4">A real-time calendar for your entire team to view and manage events together.</p>
                    <button id="launch-calendar-btn" class="w-full bg-teal-600 text-white font-semibold py-2 rounded-lg hover:bg-teal-700 transition shadow-md">Launch App</button>
                </div>
                <!-- Project Manager Card -->
                <div class="bg-white/90 backdrop-blur-sm p-6 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                    <div class="flex items-center mb-4">
                        <div class="bg-purple-100 p-3 rounded-full">
                            <!-- SVG icon for tasks/checklist -->
                            <svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                        </div>
                        <h2 class="text-xl font-bold text-gray-800 ml-4">Project Manager</h2>
                    </div>
                    <p class="text-gray-700 mb-4">Manage collaborative tasks and to-do lists in real-time with your team.</p>
                    <button id="launch-project-btn" class="w-full bg-purple-600 text-white font-semibold py-2 rounded-lg hover:bg-purple-700 transition shadow-md">Launch App</button>
                </div>
                <!-- HubSpot Card (Placeholder) -->
                <div class="bg-white/90 backdrop-blur-sm p-6 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                    <div class="flex items-center mb-4">
                        <div class="bg-orange-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        </div>
                        <h2 class="text-xl font-bold text-gray-800 ml-4">CRM Access</h2>
                    </div>
                    <p class="text-gray-700 mb-4">Access customer relationship management tools (Placeholder).</p>
                    <a href="#" class="block text-center w-full bg-gray-400 text-white font-semibold py-2 rounded-lg cursor-not-allowed opacity-75">Connect</a>
                </div>
            </div>
        </div>
        
        <!-- Shared Calendar Section -->
        <div id="calendar-section" class="hidden fade-in w-full max-w-4xl mx-auto">
            <header class="bg-white/95 backdrop-blur-sm p-6 rounded-xl shadow-xl mb-8 flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                <button id="back-to-dashboard-btn" class="bg-gray-200 text-gray-800 font-semibold px-5 py-2 rounded-lg hover:bg-gray-300 transition shadow-md">&larr; Dashboard</button>
                <div class="flex items-center space-x-3">
                    <button id="prev-month-btn" class="bg-teal-500 text-white p-3 rounded-full hover:bg-teal-600 transition shadow-md">&larr;</button>
                    <h2 id="month-year" class="text-xl font-bold text-gray-800"></h2>
                    <button id="next-month-btn" class="bg-teal-500 text-white p-3 rounded-full hover:bg-teal-600 transition shadow-md">&rarr;</button>
                </div>
            </header>
            <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-xl p-4 sm:p-6">
                <div class="grid grid-cols-7 gap-1 sm:gap-2 text-center font-bold text-gray-700 mb-4 text-sm sm:text-base">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1 sm:gap-2"></div>
            </div>
        </div>

        <!-- Project Manager Section (NEW) -->
        <div id="project-manager-section" class="hidden fade-in w-full max-w-lg mx-auto">
            <header class="bg-white/95 backdrop-blur-sm p-6 rounded-xl shadow-xl mb-8 flex justify-between items-center">
                <button id="back-to-dashboard-btn-2" class="bg-gray-200 text-gray-800 font-semibold px-5 py-2 rounded-lg hover:bg-gray-300 transition shadow-md">&larr; Dashboard</button>
                <h2 class="text-2xl font-bold text-purple-700">Team To-Do List</h2>
            </header>

            <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-xl p-6">
                <!-- Add Task Form -->
                <div class="mb-6 flex space-x-2">
                    <input type="text" id="project-task-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Add a new team task...">
                    <button id="add-project-btn" class="bg-purple-600 text-white px-4 py-3 rounded-lg hover:bg-purple-700 transition font-semibold shadow-md flex-shrink-0">Add</button>
                </div>
                
                <!-- Task List -->
                <div id="project-task-list" class="space-y-3">
                    <!-- Tasks will be injected here -->
                    <p class="text-gray-500 text-center py-4">Loading tasks...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Event Modal (Calendar) -->
    <div id="event-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Add New Event</h3>
            <p id="modal-date" class="mb-4 text-gray-600 font-medium"></p>
            <input type="text" id="event-title-input" class="w-full p-3 border border-gray-300 rounded-lg mb-6 focus:ring-teal-500 focus:border-teal-500" placeholder="Event title (e.g., Team Meeting)" required>
            <div class="flex justify-end space-x-3">
                <button id="close-modal-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-300 transition">Cancel</button>
                <button id="save-event-btn" class="bg-teal-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-teal-700 transition shadow-md">Save Event</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal (Calendar) -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-red-600">Confirm Deletion</h3>
            <p class="mb-6 text-gray-600">Do you really want to delete this event? This action cannot be undone and will be removed for everyone.</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-confirm-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-300 transition">Cancel</button>
                <button id="confirm-delete-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700 transition shadow-md">Yes, Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"; 

        // --- DOM ELEMENTS ---
        const loginSection = document.getElementById('login-section');
        const appsDashboard = document.getElementById('apps-dashboard');
        const calendarSection = document.getElementById('calendar-section');
        const projectManagerSection = document.getElementById('project-manager-section'); 
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const errorMessage = document.getElementById('error-message');
        const launchCalendarBtn = document.getElementById('launch-calendar-btn');
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
        const userIdDisplay = document.getElementById('user-id-display'); // NEW REF
        
        // Calendar Refs
        const monthYearEl = document.getElementById('month-year');
        const calendarGrid = document.getElementById('calendar-grid');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const eventModal = document.getElementById('event-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const saveEventBtn = document.getElementById('save-event-btn');
        const eventTitleInput = document.getElementById('event-title-input');
        const modalDateEl = document.getElementById('modal-date');
        const confirmModal = document.getElementById('confirm-modal');
        const cancelConfirmBtn = document.getElementById('cancel-confirm-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        
        // Project Manager Refs
        const launchProjectBtn = document.getElementById('launch-project-btn');
        const backToDashboardBtn2 = document.getElementById('back-to-dashboard-btn-2');
        const projectTaskInput = document.getElementById('project-task-input');
        const addProjectBtn = document.getElementById('add-project-btn');
        const projectTaskList = document.getElementById('project-task-list');

        const notification = document.getElementById('notification');

        // --- APP STATE ---
        let currentDate = new Date();
        let events = [];
        let projects = []; 
        let selectedDate = null;
        let db;
        let auth;
        let eventToDeleteId = null;

        // --- UTILITIES ---
        function showNotification(message, isError = true) {
            notification.textContent = message;
            notification.className = `fixed top-5 right-5 text-white py-3 px-5 rounded-lg shadow-xl fade-in z-50 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            notification.classList.remove('hidden');
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3500);
        }

        // --- FIREBASE SETUP (Runs on initial load) ---
        async function initializeFirebase() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                if (!firebaseConfig.apiKey) {
                    showNotification("Database services are unavailable: Firebase config missing.");
                    return;
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate (anonymously or with custom token)
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // Display the authenticated user ID for confirmation
                if (auth.currentUser && userIdDisplay) {
                    userIdDisplay.textContent = auth.currentUser.uid || 'Anonymous';
                }
                
                // --- Calendar Listener ---
                const eventsCollectionPath = `/artifacts/${appId}/public/data/calendarEvents`;
                const eventsCollection = collection(db, eventsCollectionPath);
                
                onSnapshot(eventsCollection, (snapshot) => {
                    events = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    events.sort((a, b) => {
                        if (a.date < b.date) return -1;
                        if (a.date > b.date) return 1;
                        if (a.createdAt && b.createdAt) {
                            const aSeconds = typeof a.createdAt.seconds === 'number' ? a.createdAt.seconds : 0;
                            const bSeconds = typeof b.createdAt.seconds === 'number' ? b.createdAt.seconds : 0;
                            return aSeconds - bSeconds;
                        }
                        return 0;
                    });
                    if (!calendarSection.classList.contains('hidden')) {
                         renderCalendar();
                    }
                }, (error) => {
                    console.error("Firestore Error (Calendar):", error);
                });


                // --- Project Manager Listener ---
                const projectsCollectionPath = `/artifacts/${appId}/public/data/projects`;
                const projectsCollection = collection(db, projectsCollectionPath);

                onSnapshot(projectsCollection, (snapshot) => {
                    projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Sort by completion status (incomplete first) then by creation time
                    projects.sort((a, b) => {
                        if (a.completed !== b.completed) {
                            return a.completed ? 1 : -1;
                        }
                        if (a.createdAt && b.createdAt) {
                            const aSeconds = typeof a.createdAt.seconds === 'number' ? a.createdAt.seconds : 0;
                            const bSeconds = typeof b.createdAt.seconds === 'number' ? b.createdAt.seconds : 0;
                            return aSeconds - bSeconds;
                        }
                        return 0;
                    });

                    if (!projectManagerSection.classList.contains('hidden')) {
                         renderProjects();
                    }
                }, (error) => {
                    console.error("Firestore Error (Projects):", error);
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showNotification("Could not connect to services. Check console for details.");
            }
        }

        // --- MOCK AUTHENTICATION & NAVIGATION ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === 'user' && password === 'password') {
                loginSection.classList.add('hidden');
                calendarSection.classList.add('hidden'); 
                projectManagerSection.classList.add('hidden'); 
                appsDashboard.classList.remove('hidden');
                errorMessage.classList.add('hidden');
            } else {
                errorMessage.classList.remove('hidden');
            }
        });

        logoutButton.addEventListener('click', () => {
            appsDashboard.classList.add('hidden');
            calendarSection.classList.add('hidden');
            projectManagerSection.classList.add('hidden');
            loginSection.classList.remove('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        });
        
        // Navigate to Calendar
        launchCalendarBtn.addEventListener('click', () => {
            appsDashboard.classList.add('hidden');
            projectManagerSection.classList.add('hidden');
            calendarSection.classList.remove('hidden');
            renderCalendar(); 
        });

        // Navigate to Project Manager 
        launchProjectBtn.addEventListener('click', () => {
            appsDashboard.classList.add('hidden');
            calendarSection.classList.add('hidden');
            projectManagerSection.classList.remove('hidden');
            renderProjects(); 
        });

        // Back button from Calendar
        backToDashboardBtn.addEventListener('click', () => {
            calendarSection.classList.add('hidden');
            appsDashboard.classList.remove('hidden');
        });
        
        // Back button from Project Manager 
        backToDashboardBtn2.addEventListener('click', () => {
            projectManagerSection.classList.add('hidden');
            appsDashboard.classList.remove('hidden');
        });


        // --- CALENDAR LOGIC (UNCHANGED) ---
        function renderCalendar() {
            if (!calendarGrid) return;

            calendarGrid.innerHTML = '';
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            
            monthYearEl.textContent = currentDate.toLocaleDateString('default', { month: 'long', year: 'numeric' });
            
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarGrid.insertAdjacentHTML('beforeend', '<div class="border border-gray-200 rounded-lg p-2 bg-gray-50/50 day-cell"></div>');
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayEvents = events.filter(e => e.date === dateStr);
                
                let eventsHtml = '';
                if (dayEvents.length > 0) {
                    eventsHtml = `<div class="mt-1 text-left text-xs space-y-1">`;
                    dayEvents.forEach(event => {
                         eventsHtml += `<div class="flex items-center justify-between p-1 bg-teal-100/80 rounded-md border border-teal-200 shadow-sm text-gray-800">
                            <span class="flex-grow truncate text-[10px] sm:text-xs font-medium" title="${event.title}">${event.title}</span>
                            <button data-id="${event.id}" class="delete-event-btn ml-1 text-red-500 hover:text-red-700 font-bold p-0.5 rounded-full leading-none transition-colors">&times;</button>
                         </div>`;
                    });
                    eventsHtml += `</div>`;
                }

                const today = new Date();
                const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                
                let dayClasses = 'border border-gray-300 rounded-lg p-2 sm:p-3 flex flex-col day-cell cursor-pointer transition hover:shadow-lg hover:border-teal-400 bg-white';
                if(isToday) dayClasses += ' border-teal-500 ring-2 ring-teal-300 bg-teal-50/50';

                calendarGrid.insertAdjacentHTML('beforeend', `
                    <div class="${dayClasses}" data-date="${dateStr}">
                        <div class="font-bold self-start text-sm sm:text-base ${isToday ? 'bg-teal-600 text-white rounded-full w-6 h-6 flex items-center justify-center shadow-md' : 'text-gray-800'}">${day}</div>
                        ${eventsHtml}
                    </div>
                `);
            }
        }

        // --- CALENDAR EVENT HANDLERS (UNCHANGED) ---
        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });
        
        calendarGrid.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-event-btn')) {
                eventToDeleteId = e.target.dataset.id;
                confirmModal.classList.remove('hidden');
            } else {
                const dayCell = e.target.closest('[data-date]');
                if (dayCell) {
                    selectedDate = dayCell.dataset.date;
                    modalDateEl.textContent = new Date(selectedDate + 'T00:00:00').toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    eventTitleInput.value = '';
                    eventModal.classList.remove('hidden');
                    eventTitleInput.focus();
                }
            }
        });

        closeModalBtn.addEventListener('click', () => eventModal.classList.add('hidden'));
        saveEventBtn.addEventListener('click', addEvent);
        
        cancelConfirmBtn.addEventListener('click', () => {
            eventToDeleteId = null;
            confirmModal.classList.add('hidden');
        });
        
        confirmDeleteBtn.addEventListener('click', () => {
            if (eventToDeleteId) {
                deleteEvent(eventToDeleteId);
            }
            eventToDeleteId = null;
            confirmModal.classList.add('hidden');
        });

        // --- CALENDAR FIRESTORE FUNCTIONS (UNCHANGED) ---
        async function addEvent() {
            const title = eventTitleInput.value.trim();
            if (!db || !auth) {
                 showNotification("Cannot save event. Database connection failed.");
                 return;
            }
            if (title && selectedDate) {
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const eventsCollection = collection(db, `/artifacts/${appId}/public/data/calendarEvents`);
                    await addDoc(eventsCollection, {
                        date: selectedDate,
                        title: title,
                        createdAt: serverTimestamp()
                    });
                    eventModal.classList.add('hidden');
                    showNotification("Event added successfully!", false);
                } catch (e) {
                    console.error("Error adding document: ", e);
                    showNotification("Failed to add event: Connection error.");
                }
            } else if (!title) {
                showNotification("Please enter an event title.");
            }
        }

        async function deleteEvent(eventId) {
            if (!db || !auth) {
                 showNotification("Cannot delete event. Database connection failed.");
                 return;
            }
             try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                await deleteDoc(doc(db, `/artifacts/${appId}/public/data/calendarEvents`, eventId));
                showNotification("Event deleted successfully!", false);
            } catch (e) {
                console.error("Error deleting document: ", e);
                showNotification("Failed to delete event: Connection error.");
            }
        }

        // --- PROJECT MANAGER LOGIC (UNCHANGED) ---
        function renderProjects() {
            if (!projectTaskList) return;

            if (projects.length === 0) {
                projectTaskList.innerHTML = '<p class="text-gray-500 text-center py-4">No tasks yet! Add one above.</p>';
                return;
            }

            projectTaskList.innerHTML = projects.map(project => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg shadow-sm border border-gray-200 hover:bg-gray-100 transition">
                    <div class="flex items-center flex-grow cursor-pointer" data-id="${project.id}" data-action="toggle-completed">
                        <input type="checkbox" ${project.completed ? 'checked' : ''} class="w-5 h-5 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500 mr-3 pointer-events-none">
                        <span class="text-gray-800 font-medium ${project.completed ? 'completed' : ''}">${project.title}</span>
                    </div>
                    <button data-id="${project.id}" data-action="delete" class="text-red-500 hover:text-red-700 font-bold p-1 rounded-full transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `).join('');
        }

        // Project Manager Event Listeners
        addProjectBtn.addEventListener('click', addProject);
        projectTaskInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addProject();
        });

        projectTaskList.addEventListener('click', (e) => {
            const container = e.target.closest('[data-id]');
            if (!container) return;
            const id = container.dataset.id;
            const action = container.dataset.action || e.target.closest('button')?.dataset.action;

            if (action === 'delete') {
                deleteProject(id);
            } else if (action === 'toggle-completed') {
                const project = projects.find(p => p.id === id);
                if (project) {
                    toggleProjectCompleted(id, !project.completed);
                }
            }
        });

        // --- PROJECT MANAGER FIRESTORE FUNCTIONS (UNCHANGED) ---
        async function addProject() {
            const title = projectTaskInput.value.trim();
            if (!db || !auth) {
                 showNotification("Cannot save task. Database connection failed.");
                 return;
            }
            if (title) {
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const projectsCollection = collection(db, `/artifacts/${appId}/public/data/projects`);
                    await addDoc(projectsCollection, {
                        title: title,
                        completed: false,
                        createdAt: serverTimestamp()
                    });
                    projectTaskInput.value = '';
                    showNotification("Task added successfully!", false);
                } catch (e) {
                    console.error("Error adding project: ", e);
                    showNotification("Failed to add task: Connection error.");
                }
            } else {
                showNotification("Please enter a task description.");
            }
        }

        async function deleteProject(projectId) {
            if (!db || !auth) {
                 showNotification("Cannot delete task. Database connection failed.");
                 return;
            }
             try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                await deleteDoc(doc(db, `/artifacts/${appId}/public/data/projects`, projectId));
                showNotification("Task deleted successfully!", false);
            } catch (e) {
                console.error("Error deleting project: ", e);
                showNotification("Failed to delete task: Connection error.");
            }
        }

        async function toggleProjectCompleted(projectId, completedStatus) {
            if (!db || !auth) {
                 showNotification("Cannot update task. Database connection failed.");
                 return;
            }
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const projectRef = doc(db, `/artifacts/${appId}/public/data/projects`, projectId);
                await updateDoc(projectRef, {
                    completed: completedStatus
                });
                // No notification needed for a simple toggle, as the snapshot listener handles the UI update
            } catch (e) {
                console.error("Error toggling completion: ", e);
                showNotification("Failed to update task status: Connection error.");
            }
        }


        // Initialize the app on page load
        initializeFirebase();

    </script>
</body>
</html>

